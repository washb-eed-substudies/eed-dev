---
title: "EED-Development Draft Table 1"
output:
  officedown::rdocx_document: 
    tables:
      style: Table Normal
  html_notebook: default
---

```{r setup, include = F}
rm(list = ls())

knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(kableExtra)
library(stringr)
library(tableone)
library(flextable)
library(officer)
library(here)
library(labelled)
library(gtsummary)
library(haven)

# CoopG/tableone2flextable
tableone2flextable <- function(tableone){
  rows <- nrow(tableone)
  cols <- ncol(tableone)
  rowsXcols <- rows*cols
  colnames <- colnames(tableone)
  
  listoflists <- list()
  
  for (i in 1:cols){
    start <- (i*rows+1)-rows
    end <- i*rows
    
    listoflists[[i]] <- tableone[start:end]
  }
  
  dataframe <- as.data.frame(listoflists, col.names = colnames)
  flex <- flextable::flextable(dataframe)
  
  return(flex)
}
```

```{r}
bg <- readRDS(here('final-data/eed-dev_bg.RDS')) %>% 
  rename(hh_index = HHwealth) %>% 
  mutate(across(c(cesd_sum_t2, cesd_sum_ee_t3,
                  pss_sum_mom_t3), 
                as.numeric), 
         life_viol_any_t3 = case_when(as.character(life_viol_any_t3) == "missing" ~ NA_character_, 
                                      TRUE ~ as.character(life_viol_any_t3)) %>% 
           factor(),
         sex = factor(sex, c("female", "male")),
         country = 'Bangladesh', 
  )

k <- readRDS(here('final-data/eed-dev_k.RDS')) %>% 
  mutate(across(c(pss_score, phq_score_t3), 
                as.numeric), 
         sex = factor(sex, c("female", "male")),
         country = 'Kenya')
```

```{r}
# filter out children without any exposure or any outcome

bg <- bg %>% 
  filter(if_any(c('ln_aat1', 'ln_mpo1', 'ln_neo1',
                  'ln_L_conc_t1', 'ln_M_conc_t1',
                  
                  'ln_aat2', 'ln_mpo2', 'ln_neo2',
                  'ln_L_conc_t2', 'ln_M_conc_t2',
                  'ln_reg2'),
                ~ !is.na(.)) & 
           if_any(c(
             starts_with("who_"),
             z_age2mo_cdi_undyr1_all_no4,
             z_age2mo_cdi_sayyr1_all_no4,
             
             z_age2mo_personal_no4,
             z_age2mo_motor_no4,
             z_age2mo_combined_no4,
             z_age2mo_com_no4,
             z_age2mo_cdi_undyr2_all_no4,
             z_age2mo_cdi_sayyr2_all_no4),
             ~ !is.na(.)))

k <- k %>% 
  filter(if_any(c('ln_aat1', 'ln_mpo1', 'ln_neo1',
                  'ln_Lact1', 'ln_Mann1',
                  
                  'ln_aat2', 'ln_mpo2', 'ln_neo2',
                  'ln_Lact2', 'ln_Mann2'),
                ~ !is.na(.)) & 
           if_any(c(
             starts_with("who_"),
             z_comtot_no4_activec,
             z_mottot_no4_activec,
             z_pstot_no4_activec,
             z_globaltot_no4_activec),
             ~ !is.na(.)))
```


```{r}
# bg$birthord <- factor(bg$birthord, 
#                       levels = c("first", "second or greater", "missing"),
#                       ordered = TRUE)

bg$hfiacat <- factor(bg$hfiacat, 
                     levels = c("Mildly Food Insecure", "Moderately Food Insecure", 
                                "Severely Food Insecure", "Food Secure"),
                     ordered = TRUE)

var_label(bg) <- list(# tr = "Treatment Arm", 
  laz_t1 = "Length-for-age Z score (3 mo)", 
  waz_t1 = "Weight-for-age Z score (3 mo)", 
  laz_t2 = "Length-for-age Z score (14 mo)", 
  waz_t2 = "Weight-for-age Z score (14 mo)", 
  tr = "Treatment Arm",
  diar7d_t2 = "Caregiver reported diarrhea 7-day recall (3 mo)",
  diar7d_t3 = "Caregiver reported diarrhea 7-day recall (14 mo)",
  cesd_sum_t2 = "Depressive symptoms (CESD-R score*) at Year 1", 
  cesd_sum_ee_t3 = "Depressive symptoms (CESD-R score*) at Year 2",
  pss_sum_mom_t3 = "Maternal Perceived Stress Scale (PSS) at Year 2",
  sex = "Female (%)",
  momage = "Age (years)", 
  momheight_raw = "Height (cm)", 
  momedu = "Education completed", 
  hfiacat = "Household food insecurity**",
  ageday_st1 = "Age at EED biomarker measurement, Follow-up 1 (months)",
  ageday_st2 = "Age at EED biomarker measurement, Follow-up 2 (months)",
  agedays_motor = "Age at child development measurement, Follow-up 2 (Year 1) (months)",
  agedays_cdi3 = "Age at child development measurement, Follow-up 3 (Year 2) (months)"
  # life_viol_any_t3 = "Cumulative maternal exposure to intimate partner violence",
  # floor = "Housing material, improved floor" 
  # birthord = "Birth Order", 
  # Nlt18 = "Number of children < 18 years old", 
  # Ncomp = "Total individuals in compound",
  # watmin = "Minutes to primary water source", 
  # walls = "Housing material, improved walls", 
  # roof = "Housing material, improved roof", 
  # hh_index = "Household wealth index"
)
```

# Table 1. Characteristics of participants in Bangladesh

```{r, tab.cap = "Bangladesh"}

baselinechar_bg <- function(data){
  
  bg_child <- data %>% 
    mutate(across(c(ageday_st1, ageday_st2,
                    agedays_motor, agedays_cdi3),
                  ~ . / 30.5)) %>% 
    tbl_summary(include = c(sex, laz_t1, waz_t1, 
                            laz_t2, waz_t2,
                            diar7d_t2, diar7d_t3,
                            ageday_st1, ageday_st2,
                            agedays_motor, agedays_cdi3),
                type = list(sex ~ "dichotomous",
                            c(laz_t1, waz_t1,
                              laz_t2, waz_t2,
                              ageday_st1, ageday_st2,
                              agedays_motor, agedays_cdi3) ~ "continuous"),
                value = list(sex ~ "female"),
                digits = list(all_categorical() ~ c(0, 2),
                              all_continuous() ~ c(2, 2, 2)),
                missing = "no")
  
  bg_mom <- data %>% 
    tbl_summary(include = c(momage, momheight_raw,
                            cesd_sum_t2, cesd_sum_ee_t3,
                            pss_sum_mom_t3, momedu),
                digits = list(all_categorical() ~ c(0, 2),
                              all_continuous() ~ c(2, 2, 2),
                              cesd_sum_t2 ~ 0),
                type = list(c(momage,
                              cesd_sum_t2,
                              cesd_sum_ee_t3) ~ "continuous"),
                missing = "no")
  
  bg_house <- data %>% 
    tbl_summary(include = c(hfiacat, 
                            tr),
                digits = list(all_categorical() ~ c(0, 2)),
                missing = "no")
  
  return(
    list(
      "bg_child" = bg_child,
      "bg_mom"   = bg_mom, 
      "bg_house" = bg_house
    )
  )
}


tbl_all_bg <- bg %>% 
  baselinechar_bg()

tbl_all_bg %>% 
  tbl_stack(group_header = c("Child", "Mother", "Household")) %>%
  as_gt() %>%
  gt::tab_style(
    style = gt::cell_text(weight = "bold"),
    locations = gt::cells_row_groups(groups = everything())
  ) 
```


\* CESD-R = Center for Epidemiologic Studies Depression Scale Revised.

** Any level of food insecurity assessed using the Household Food Insecurity Access Scale 


```{r}
k <- k %>% 
  mutate(momedu = factor(momedu, 
                         levels = c("Primary", "IncompletePrimary", 
                                    "AnySecondary", "missing"),
                         labels = c("Primary", "Incomplete Primary", 
                                    "Any Secondary", "Missing"), 
                         ordered = T),
         hhs_mod_sev = HHS %in% c(2, 3),
         across(starts_with("diarr7_t"), 
                ~ factor(.x, c("0", "1"))))

var_label(k) <- list(# tr = "Treatment Arm", 
  laz_t1 = "Length-for-age Z score (6 mo)", 
  waz_t1 = "Weight-for-age Z score (6 mo)", 
  laz_t2 = "Length-for-age Z score (17 mo)", 
  waz_t2 = "Weight-for-age Z score (17 mo)", 
  tr = "Treatment Arm", 
  # diarr7_t0 = "Caregiver reported diarrhea 7-day recall (6 mo)",
  # diarr7_t1 = "Caregiver reported diarrhea 7-day recall (17 mo)",
  pss_score = "Maternal Perceived Stress Scale (PSS) at Year 2",
  phq_score_t3 = "Depressive symptoms (PHQ*) at Year 2",
  sex = "Female (%)",
  momage = "Age (years)", 
  momheight_raw = "Height (cm)", 
  momedu = "Education completed", 
  hhs_mod_sev = "Prevalence of moderate to severe household hunger**",
  aged1 = "Age at EED biomarker measurement, Follow-up 1 (months)",
  aged2 = "Age at EED biomarker measurement, Follow-up 2 (months)",
  agedays_motor = "Age at child development measurement, Follow-up 2 (Year 1) (months)",
  childage_dev = "Age at child development measurement, Follow-up 3 (Year 2) (months)"
  # Nlt18 = "Number of children < 18 years old", 
  # Ncomp = "Total individuals in compound",
  # water_time = "Minutes to primary water source", 
  # wall = "Housing material, walls", 
  # floor = "Housing material, floor"
  # roof = "Housing material, roof", 
  # hh_index = "Household wealth index"
)

```

\newpage

# Table 2. Characteristics of participants in Kenya

```{r, tab.cap = "Kenya"}
baselinechar_kenya <- function(k_data){
  k_child <- k_data %>% 
    mutate(across(c(aged1, aged2,
                    agedays_motor, childage_dev),
                  ~ . / 30.5)) %>% 
    tbl_summary(include = c(sex, laz_t1, waz_t1, 
                            laz_t2, waz_t2,
                            # diarr7_t0, diarr7_t1,
                            aged1, aged2,
                            agedays_motor, childage_dev),
                type = list(sex ~ "dichotomous"#,
                            # diarr7_t0 ~ "dichotomous",
                            # diarr7_t1 ~ "dichotomous"
                ),
                value = list(sex ~ "female"#,
                             # diarr7_t0 ~ 1,
                             # diarr7_t1 ~ 1
                ),
                digits = list(all_categorical() ~ c(0, 2),
                              all_continuous() ~ c(2, 2, 2)),
                missing = "no")
  
  k_mom <- k_data %>% 
    tbl_summary(include = c(momage, momheight_raw,
                            phq_score_t3,
                            pss_score, momedu),
                digits = list(all_categorical() ~ c(0, 2),
                              all_continuous() ~ c(2, 2, 2)),
                missing = "no")
  
  k_house <- k_data %>% 
    tbl_summary(include = c(hhs_mod_sev,
                            tr),
                digits = list(all_categorical() ~ c(0, 2)),
                missing = "no")
  
  list("k_child" = k_child,
       "k_mom" = k_mom,
       "k_house" = k_house) 
}

tbl_all_k <- k %>% 
  baselinechar_kenya() 

tbl_all_k %>% 
  tbl_stack(group_header = c("Child", "Mother", "Household")) %>%
  as_gt() %>%
  gt::tab_style(
    style = gt::cell_text(weight = "bold"),
    locations = gt::cells_row_groups(groups = everything())
  ) 


```


\* PHQ = Patient Health Questionnaire 

** Moderate to severe hunger defined using the Household Hunger Scale


# Supplementary Tables 

## Bangladesh LTF


```{r, tab.cap = "Bangladesh LTF"}

bg_ltf <- function(data){
  default_tbl_summary <- partial(tbl_summary, 
                                 digits = list(all_categorical() ~ c(0, 2),
                                               all_continuous() ~ c(2, 2, 2)),
                                 missing = "no")
  
  # maternal 
  maternal_characteristics <- data %>% 
    default_tbl_summary(include = c(momage, 
                                    momheight_raw,
                                    momedu, 
                                    hfiacat),
                        label = list(momage ~ "Maternal age (years)", 
                                     momheight_raw ~ "Maternal height (cm)",
                                     momedu ~ "Maternal education completed",
                                     hfiacat ~ "Household food insecurity**"),
                        type = list(momage ~ "continuous"))
  
  # household 
  household_characteristics <- data %>% 
    mutate(across(c(elec, floor, roof, 
                    asset_phone, asset_moto),
                  ~ .x == 1, 
                  .names = "has_{.col}"),
           Nlt18 = as.integer(Nlt18)) %>% 
    tbl_summary(include = c(Ncomp, Nlt18,
                            has_elec, 
                            has_floor, has_roof, 
                            has_asset_phone, has_asset_moto),
                label = list(Ncomp ~ "Number of people per compound", 
                             Nlt18 ~ "Number of children <18 years in the household",
                             has_elec ~ "Has electricity", 
                             has_floor ~ "Has a cement floor",
                             has_roof ~ "Has an iron roof", 
                             has_asset_phone ~ "Owns a mobile phone",
                             has_asset_moto ~ "Owns a motorcycle"),
                type = list(Nlt18 ~ "continuous"), 
                digits = list(all_categorical() ~ c(0, 2),
                              all_continuous() ~ c(2, 2, 2),
                              c(Ncomp, Nlt18) ~ 0 ),
                missing = "no")
  
  return(list(maternal_characteristics, 
              household_characteristics))
}

ltf_cols_bg <- c("momage", "momheight_raw", "momedu", 
                 "hfiacat",
                 "elec", "floor", "roof", 
                 "asset_phone", "asset_moto",
                 "Ncomp", "Nlt18")

tbl_bg_main <- read_dta(here("raw-data/bangladesh/washb-bangladesh-enrol.dta")) %>% 
  mutate(momheight_raw = momheight,
         momedu = case_when(momedu == 0 ~ "No education", 
                            momedu == 1 ~ "Primary (1-5y)",
                            momedu == 2 ~ "Secondary (>5y)"),
         hfiacat = case_match(hfiacat, 
                              1 ~ "Food Secure",
                              2 ~ "Mildly Food Insecure", 
                              3 ~ "Moderately Food Insecure", 
                              4 ~ "Severely Food Insecure")) %>% 
  distinct(dataid, hhid, 
           pick(all_of(ltf_cols_bg))) %>% 
  bg_ltf()

tbl_bg_fullcohort <- bg %>% 
  distinct(dataid, hhid, 
           pick(all_of(ltf_cols_bg))) %>% 
  bg_ltf()

tbl_bg_ltf_y1 <- bg %>% 
  filter(if_all(c(starts_with("who_"),
                  z_age2mo_cdi_undyr1_all_no4,
                  z_age2mo_cdi_sayyr1_all_no4),
                ~ is.na(.))) %>% 
  distinct(dataid, hhid, 
           pick(all_of(ltf_cols_bg))) %>% 
  bg_ltf()

tbl_bg_ltf_y2 <- bg %>% 
  filter(if_all(c(z_age2mo_personal_no4,
                  z_age2mo_motor_no4,
                  z_age2mo_combined_no4,
                  z_age2mo_com_no4,
                  z_age2mo_cdi_undyr2_all_no4, 
                  z_age2mo_cdi_sayyr2_all_no4),
                ~ is.na(.))) %>% 
  distinct(dataid, hhid, 
           pick(all_of(ltf_cols_bg))) %>% 
  bg_ltf()

list(tbl_bg_main, 
     tbl_bg_fullcohort, 
     tbl_bg_ltf_y1,
     tbl_bg_ltf_y2) %>% 
  pmap(function(t1, t2, t3, t4){
    tbl_merge(list(t1, t2, t3, t4), 
              tab_spanner = c("Full Study", 
                              "Included", 
                              "Lost to follow-up at Year 1",
                              "Lost to follow-up at Year 2"))
  }) %>% 
  tbl_stack(group_header = c("Maternal Characteristics", 
                             "Household Characteristics")) %>% 
  modify_footnote_header(
    footnote = "N corresponds to households.",
    columns = all_stat_cols(),
    replace = FALSE
  ) 


```


\* CESD-R = Center for Epidemiologic Studies Depression Scale Revised.

** Any level of food insecurity assessed using the Household Food Insecurity Access Scale 


\newpage


## Kenya LTF

```{r, tab.cap = "Kenya LTF"}

kenya_ltf <- function(data){
  
  default_tbl_summary <- partial(tbl_summary, 
                                 digits = list(all_categorical() ~ c(0, 2),
                                               all_continuous() ~ c(2, 2, 2)),
                                 missing = "no")
  
  # maternal 
  maternal_characteristics <- data %>% 
    default_tbl_summary(include = c(momage, momheight_raw,
                                    momedu, 
                                    hhs_mod_sev),
                        label = list(momage ~ "Maternal age (years)", 
                                     momheight_raw ~ "Maternal height (cm)",
                                     momedu ~ "Maternal education completed",
                                     hhs_mod_sev ~ "Prevalence of moderate to severe household hunger**"))
  
  # household 
  household_characteristics <- data %>% 
    mutate(across(c(electricity, floor, roof, 
                    mobile, motorcycle),
                  ~ .x == 1, 
                  .names = "has_{.col}"),
           Nlt18 = as.integer(Nlt18)) %>% 
    tbl_summary(include = c(Ncomp, Nlt18,
                            has_electricity, 
                            has_floor, has_roof, 
                            has_mobile, has_motorcycle),
                label = list(Ncomp ~ "Number of people per compound", 
                             Nlt18 ~ "Number of children <18 years in the household",
                             has_electricity ~ "Has electricity", 
                             has_floor ~ "Has a cement floor",
                             has_roof ~ "Has an iron roof", 
                             has_mobile ~ "Owns a mobile phone",
                             has_motorcycle ~ "Owns a motorcycle"),
                type = list(Nlt18 ~ "continuous"), 
                digits = list(all_categorical() ~ c(0, 2),
                              all_continuous() ~ c(2, 2, 2),
                              c(Ncomp, Nlt18) ~ 0 ),
                missing = "no"
    )
  list(maternal_characteristics, 
       household_characteristics)
}

ltf_cols_k <- c("momage", "momheight_raw", "momedu", 
                 "hhs_mod_sev",
                 "elec", "floor", "roof", 
                 "mobile", "motorcycle",
                 "Ncomp", "Nlt18")

tbl_k_main <- read_csv(here("raw-data/kenya/washb-kenya-enrol.csv")) %>% 
  mutate(momedu = case_match(momedu, 
                             "IncompletePrimary" ~ "Incomplete Primary",
                             "AnySecondary"      ~ "Any Secondary",
                             "missing"           ~ "Missing", 
                             .default = momedu) %>% 
           factor(c("Primary", "Incomplete Primary", "Any Secondary", "Missing")),
         momheight_raw = momheight,
         hhs_mod_sev = HHS %in% c(2, 3)) %>% 
  kenya_ltf()

tbl_k_fullcohort <- k %>% 
  kenya_ltf()

tbl_k_ltf_y1 <- k %>% 
  filter(if_all(c(starts_with("who_")),
                ~ is.na(.))) %>% 
  kenya_ltf()

tbl_k_ltf_y2 <- k %>% 
  filter(if_all(c(z_comtot_no4_activec,
                  z_mottot_no4_activec,
                  z_pstot_no4_activec,
                  z_globaltot_no4_activec),
                ~ is.na(.))) %>% 
  kenya_ltf()

list(tbl_k_main,
     tbl_k_fullcohort, 
     tbl_k_ltf_y1,
     tbl_k_ltf_y2) %>% 
  pmap(function(t1, t2, t3, t4){
    tbl_merge(list(t1, t2, t3, t4), 
              tab_spanner = c("Full Study", 
                              "Included", 
                              "Lost to follow-up at Year 1",
                              "Lost to follow-up at Year 2"))
  }) %>% 
  tbl_stack(group_header = c("Maternal Characteristics", 
                             "Household Characteristics")) %>% 
  modify_footnote_header(
    footnote = "N corresponds to households.",
    columns = all_stat_cols(),
    replace = FALSE
  ) 


```


\* PHQ = Patient Health Questionnaire 

** Moderate to severe hunger defined using the Household Hunger Scale
